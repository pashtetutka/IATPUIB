#  Анализ данных сетевого трафика с использованием аналитической in-memory СУБД DuckDB

**Автор:** pashtet.2003@yandex.ru

## Цель работы
 - Изучить возможности СУБД DuckDB для обработки и анализ больших данных
 - Получить навыки применения DuckDB совместно с языком программирования R
 - Получить навыки анализа метаинфомации о сетевом трафике
 - Получить навыки применения облачных технологий хранения, подготовки и анализа данных: Yandex Object Storage, Rstudio Server

## Исходные данные и инструменты

- **ОС:** Windows 10  
- **Среда:** RStudio Server  
- **Язык программирования:** R 4.1  
- **СУБД:** DuckDB  
- **Библиотеки:** `dplyr`, `duckdb`

Исходный набор данных: сетевой трафик (файл `tm_data.pqt`).

## Задание 1: Надите утечку данных из Вашей сети

**Описание:**  
Внутренние хосты (IP-адреса начинаются на `12.`, `13.`, или `14.`) пересылают данные во внешние ресурсы. Среди них нужно определить тот, который пересылает максимально большой объём информации наружу.

**Подход к решению:**  
1. Подключиться к локальной базе DuckDB.
2. Загрузить исходные данные о сетевом трафике (`tm_data.pqt`) и создать на их основе таблицу в DuckDB.
3. Выполнить запрос, который:
   - Отбирает источники (`src`), чьи адреса начинаются на `12`, `13` или `14`.
   - Исключает записи, где `dst` также внутренний (то есть начинающийся на `12`, `13` или `14`).
   - Группирует по `src` и сортирует результаты по сумме байт (в порядке убывания).
   - Возвращает первую запись, являющуюся IP-адресом "утекающего" хоста.

**Код:**

```r
library(duckdb)
library(dplyr)

# Подключение к DuckDB
con <- dbConnect(duckdb())

# Загрузка и создание таблицы из файла
download.file(
    "https://storage.yandexcloud.net/arrow-datasets/tm_data.pqt", 
    destfile = "tm_data.pqt"
)
dbExecute(con, "CREATE TABLE tmdatatable AS SELECT * FROM read_parquet('tm_data.pqt')")

# Выполнение запроса
res <- dbGetQuery(con, "
  SELECT src
  FROM tmdatatable
  WHERE (src LIKE '12.%' OR src LIKE '13.%' OR src LIKE '14.%')
    AND (dst NOT LIKE '12.%' AND dst NOT LIKE '13.%' AND dst NOT LIKE '14.%')
  GROUP BY src
  ORDER BY SUM(bytes) DESC
  LIMIT 1
")
```
**Пример результата:**
```r
           src
1 13.37.84.125
```

## Задание 2: Найти утечку данных №2

**Описание:**  
Другой нарушитель настроил автоматическую задачу (через cron) для экспорта содержимого внутренней wiki-системы в нерабочие часы. В результате в определённые часы наблюдается аномально большой объём исходящего трафика во внешние сети. Необходимо определить IP-адрес этой системы. Известно, что IP-адрес данного нарушителя отличается от результата Задания 1.

**Подход к решению:**
1. Определить интервалы времени, когда исходящий трафик во внешние сети максимален.
2. Ориентируясь на нерабочие часы (определяемые аналитиком, в данном случае рассматриваем ранние часы суток), найти хост, генерирующий наибольший объем внешнего трафика в эти часы.
3. Исключить из рассмотрения ранее найденный IP-адрес нарушителя (из Задания 1).
4. Выявить новый IP-адрес.

**Код:**

```r
# Анализ трафика по часам
time_stats <- dbGetQuery(con, "
    SELECT 
        time,
        COUNT(*) AS trafictime
    FROM (
        SELECT 
            timestamp,
            src,
            dst,
            bytes,
            (
                (src LIKE '12.%' OR src LIKE '13.%' OR src LIKE '14.%')
                AND (dst NOT LIKE '12.%' AND dst NOT LIKE '13.%' AND dst NOT LIKE '14.%')
            ) AS trafic,
            EXTRACT(HOUR FROM epoch_ms(CAST(timestamp AS BIGINT))) AS time
        FROM tmdatatable
    ) sub
    WHERE trafic = TRUE 
      AND time BETWEEN 0 AND 24
    GROUP BY time
    ORDER BY trafictime DESC;
")

time_stats
```
